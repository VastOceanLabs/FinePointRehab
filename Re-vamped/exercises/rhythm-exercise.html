<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Rhythm Reach | Fine Point Rehab</title>
  <meta name="description" content="Repeat the rhythm pattern by tapping the pads. Mobile-first, accessible therapy exercise." />
  
  <!-- iOS Web App Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Rhythm Reach" />
  <meta name="mobile-web-app-capable" content="yes" />
  
  <!-- Security - no external resources, all inline -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: blob:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';" />
  
  <!-- Prevent phone number detection that can trigger warnings -->
  <meta name="format-detection" content="telephone=no" />

  <style>
    :root {
      --bg-primary: #0f1629;
      --bg-secondary: #1a1f3a;
      --bg-tertiary: #252b47;
      --text-primary: #e8eef5;
      --text-secondary: #b8c5d1;
      --text-muted: #8a96a3;
      --brand-aqua: #6fd3f5;
      --success: #4caf50;
      --error: #ff6b6b;
      --warning: #ffc107;
      --border: #374151;
      --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.3);
      --radius: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-6: 24px;
      --font-size-xs: 12px;
      --font-size-sm: 14px;
      --font-size-base: 16px;
      --font-size-lg: 20px;
      --font-size-xl: 24px;
      --font-size-2xl: 32px;
      --font-size-3xl: 48px;
      --font-weight-semibold: 600;
      --font-weight-bold: 700;
      --duration-fast: 150ms;
      --easing: cubic-bezier(0.4, 0, 0.2, 1);
      
      --pad-radius: 16px;
      --halo-fast: 160ms;
      --ease: cubic-bezier(.2,.7,.2,1);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(180deg, #0a0e1a 0%, #1a1f3a 50%, #0f1524 100%);
      color: var(--text-primary);
      min-height: 100vh;
      touch-action: manipulation;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      text-decoration: none;
      cursor: pointer;
      transition: all var(--duration-fast) var(--easing);
      min-height: 44px;
    }

    .btn:hover {
      border-color: var(--brand-aqua);
      background-color: var(--bg-tertiary);
    }

    .btn-primary {
      background-color: var(--brand-aqua);
      color: #000;
      border-color: var(--brand-aqua);
    }

    .btn-primary:hover {
      background-color: #5bc2e7;
    }

    .btn-secondary {
      background-color: var(--bg-tertiary);
    }

    .input, select {
      width: 100%;
      padding: var(--space-2) var(--space-3);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      font-size: var(--font-size-base);
    }

    .input:focus, select:focus {
      outline: none;
      border-color: var(--brand-aqua);
      box-shadow: 0 0 0 2px rgba(111, 211, 245, 0.25);
    }

    .panel {
      background: rgba(15, 22, 41, 0.8);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      box-shadow: var(--shadow-lg);
    }

    .site-header {
      position: sticky;
      top: 0;
      z-index: 1000;
      backdrop-filter: blur(8px);
      background: rgba(8, 15, 35, 0.8);
      border-bottom: 1px solid var(--border);
    }

    .site-header .inner {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      max-width: 1200px;
      margin: 0 auto;
    }

    .site-header h1 {
      margin: 0;
      font-size: var(--font-size-xl);
      line-height: 1.2;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--space-4);
    }

    [data-screen] {
      display: none !important;
    }

    [data-screen].active {
      display: block !important;
    }

    .settings-panel {
      max-width: 480px;
      margin: 0 auto;
      padding-top: var(--space-6);
    }

    .settings-panel h2 {
      margin: 0 0 var(--space-4);
      font-size: var(--font-size-lg);
      text-align: center;
    }

    .game-description {
      background: var(--bg-tertiary);
      border-radius: var(--radius);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
      border: 1px solid var(--border);
    }

    .game-description p {
      margin: 0 0 var(--space-3);
    }

    .game-description p:last-child {
      margin: 0;
    }

    .stats-row {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: var(--space-4);
    }

    .metric-settings {
      flex: 0 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: var(--space-2) var(--space-3);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(111, 211, 245, 0.08);
      min-width: 110px;
    }

    .pb-value {
      font-weight: var(--font-weight-bold);
      font-size: var(--font-size-lg);
      color: var(--brand-aqua);
      text-shadow: 0 0 6px rgba(111, 211, 245, 0.5);
      line-height: 1.1;
    }

    .pb-label {
      font-size: var(--font-size-xs);
      opacity: 0.9;
      margin-top: var(--space-1);
      color: var(--text-secondary);
    }

    .settings-group {
      margin-bottom: var(--space-4);
    }

    .settings-label {
      display: block;
      margin-bottom: var(--space-2);
      font-weight: var(--font-weight-semibold);
    }

    .setting-help {
      display: block;
      color: var(--text-muted);
      font-size: var(--font-size-xs);
      margin-top: var(--space-1);
      font-style: italic;
    }

    .controls {
      display: flex;
      gap: var(--space-2);
      justify-content: center;
      flex-wrap: wrap;
    }

    /* Checkbox styling */
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      cursor: pointer;
    }

    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: var(--brand-aqua);
      cursor: pointer;
    }

    /* Game screen */
    .game-container {
      display: grid;
      gap: var(--space-4);
    }

    .hud {
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: 1fr;
      gap: var(--space-2);
      align-items: center;
    }

    .hud-group {
      display: grid;
      gap: var(--space-1);
      text-align: center;
    }

    .hud-value {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-bold);
      color: var(--brand-aqua);
      text-shadow: 0 0 8px rgba(111, 211, 245, 0.7);
    }

    .hud-label {
      font-size: var(--font-size-xs);
      color: var(--text-secondary);
      opacity: 0.9;
    }

    /* Status indicator */
    .status-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-lg);
      font-weight: var(--font-weight-bold);
      font-size: var(--font-size-lg);
      transition: all 0.3s var(--ease);
      min-height: 56px;
    }

    .status-bar.watching {
      background: linear-gradient(135deg, rgba(255, 193, 7, 0.2), rgba(255, 152, 0, 0.15));
      border: 2px solid var(--warning);
      color: var(--warning);
    }

    .status-bar.your-turn {
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(56, 142, 60, 0.15));
      border: 2px solid var(--success);
      color: var(--success);
      animation: pulse-green 1.5s ease-in-out infinite;
    }

    .status-bar.countdown {
      background: linear-gradient(135deg, rgba(111, 211, 245, 0.2), rgba(79, 195, 247, 0.15));
      border: 2px solid var(--brand-aqua);
      color: var(--brand-aqua);
    }

    .status-bar.success {
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(56, 142, 60, 0.2));
      border: 2px solid var(--success);
      color: var(--success);
    }

    @keyframes pulse-green {
      0%, 100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); }
      50% { box-shadow: 0 0 0 8px rgba(76, 175, 80, 0); }
    }

    .status-icon {
      font-size: var(--font-size-xl);
    }

    .progress-indicator {
      font-size: var(--font-size-sm);
      opacity: 0.9;
      margin-left: var(--space-2);
    }

    /* Countdown overlay */
    .countdown-overlay {
      position: fixed;
      inset: 0;
      background: rgba(10, 14, 26, 0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .countdown-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .countdown-number {
      font-size: 120px;
      font-weight: var(--font-weight-bold);
      color: var(--brand-aqua);
      text-shadow: 0 0 40px rgba(111, 211, 245, 0.8);
      animation: countdown-pop 0.5s ease-out;
    }

    @keyframes countdown-pop {
      0% { transform: scale(0.5); opacity: 0; }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); opacity: 1; }
    }

    /* Success message */
    .success-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-bold);
      color: var(--success);
      text-shadow: 0 0 20px rgba(76, 175, 80, 0.8);
      opacity: 0;
      pointer-events: none;
      z-index: 100;
    }

    .success-message.show {
      animation: success-pop 0.8s ease-out forwards;
    }

    @keyframes success-pop {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
      20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(1) translateY(-30px); }
    }

    /* Summary screen */
    .summary-panel {
      max-width: 480px;
      margin: 0 auto;
      padding-top: var(--space-6);
      text-align: center;
    }

    .summary-panel h2 {
      margin: 0 0 var(--space-6);
      font-size: var(--font-size-xl);
      color: var(--brand-aqua);
    }

    .summary-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-3);
      margin-bottom: var(--space-6);
    }

    .summary-stat {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
    }

    .summary-stat-value {
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-bold);
      color: var(--brand-aqua);
      text-shadow: 0 0 8px rgba(111, 211, 245, 0.5);
    }

    .summary-stat-label {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      margin-top: var(--space-1);
    }

    .summary-stat.highlight {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, rgba(111, 211, 245, 0.15), rgba(79, 195, 247, 0.1));
      border-color: var(--brand-aqua);
    }

    .summary-stat.new-pb {
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(56, 142, 60, 0.15));
      border-color: var(--success);
    }

    .summary-stat.new-pb .summary-stat-value {
      color: var(--success);
    }

    .new-pb-badge {
      display: inline-block;
      background: var(--success);
      color: #000;
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-bold);
      padding: 2px 8px;
      border-radius: 20px;
      margin-top: var(--space-2);
      animation: bounce 0.5s ease infinite alternate;
    }

    @keyframes bounce {
      from { transform: translateY(0); }
      to { transform: translateY(-3px); }
    }

    .summary-controls {
      display: flex;
      gap: var(--space-3);
      justify-content: center;
      flex-wrap: wrap;
    }

    @media (max-width: 768px) {
      .hud {
        grid-template-columns: 1fr 1fr 1fr;
        grid-auto-flow: row;
        gap: var(--space-1);
      }
      
      .hud-value {
        font-size: var(--font-size-base);
      }
      
      .hud-label {
        font-size: 11px;
      }
      
      .hud .controls {
        grid-column: 1 / -1;
        margin-top: var(--space-1);
      }
      
      .hud .controls .btn {
        padding: 6px 12px;
        font-size: 13px;
      }

      .status-bar {
        font-size: var(--font-size-base);
        padding: var(--space-2) var(--space-3);
        min-height: 48px;
      }

      .countdown-number {
        font-size: 80px;
      }

      .summary-stats {
        grid-template-columns: 1fr;
      }

      .summary-stat.highlight {
        grid-column: 1;
      }
    }

    .grid-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: var(--space-4);
      position: relative;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(72px, 1fr));
      gap: clamp(10px, 3vw, 16px);
      max-width: 520px;
      width: 100%;
    }

    /* Pads */
    button.pad,
    .pad,
    .pad:active,
    .pad:focus,
    .pad:focus-visible,
    .pad.glow,
    .pad.glow:active,
    .pad.glow:focus,
    .pad.glow:focus-visible {
      background: none !important;
      background-image: none !important;
      background-color: transparent !important;
      -webkit-appearance: none;
      appearance: none;
    }

    .pad {
      width: 100%;
      aspect-ratio: 1;
      border-radius: var(--pad-radius);
      border: 1px solid rgba(255,255,255,0.10);
      background:
        radial-gradient(120% 120% at 30% 30%, rgba(120,150,255,0.16) 0%, rgba(120,150,255,0.06) 40%, rgba(20,26,46,0.88) 70%),
        linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0));
      box-shadow: inset 0 0 0 1px rgba(140,170,255,0.15), 0 8px 18px rgba(0,0,0,0.35);
      position: relative;
      overflow: hidden;
      cursor: pointer;
      display: grid;
      place-items: center;
      color: var(--text-secondary);
      font-weight: var(--font-weight-bold);
      letter-spacing: 0.4px;
      transition: transform 120ms var(--ease), box-shadow 160ms var(--ease), border-color 160ms var(--ease);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .pad::after {
      content: "";
      position: absolute;
      inset: -20%;
      opacity: 0;
      pointer-events: none;
      background: radial-gradient(120% 120% at 50% 50%,
                  rgba(120,170,255,0.40) 0%,
                  rgba(120,170,255,0.22) 35%,
                  rgba(120,170,255,0.06) 65%,
                  transparent 75%);
      filter: blur(10px);
      transform: scale(0.92);
      transition: opacity var(--halo-fast) var(--ease), transform var(--halo-fast) var(--ease);
    }

    .pad.glow {
      border-color: rgba(150,190,255,0.85) !important;
      box-shadow: inset 0 0 0 1px rgba(160,190,255,0.45), 0 0 0 2px rgba(120,170,255,0.12), 0 10px 24px rgba(60,100,200,0.55) !important;
    }

    .pad.glow::after {
      opacity: 1;
      transform: scale(1);
    }

    .pad:focus {
      outline: none;
    }

    .pad:active {
      transform: translateY(1px);
    }

    .pad.wrong {
      box-shadow: inset 0 0 0 1px rgba(255,120,120,0.7), 0 10px 22px rgba(255,60,60,0.45);
      border-color: rgba(255,140,140,0.9);
    }

    :focus-visible {
      outline: 3px solid rgba(111, 211, 245, 0.85);
      outline-offset: 2px;
    }

    @media (max-width: 768px) {
      .settings-panel {
        padding: var(--space-3);
        margin: var(--space-2);
      }
      
      .page {
        padding: var(--space-2);
      }
    }
  </style>
</head>

<body>
  <header class="site-header">
    <div class="inner">
      <a class="btn btn-secondary" href="/" aria-label="Go to Home">‚Üê Home</a>
      <h1>Rhythm Reach</h1>
    </div>
  </header>

  <!-- Countdown Overlay -->
  <div class="countdown-overlay" id="countdownOverlay">
    <div class="countdown-number" id="countdownNumber">3</div>
  </div>

  <main class="page">
    <!-- Settings Screen -->
    <aside class="settings-panel panel active" data-screen="settings">
      <h2>Session Settings</h2>

      <div class="game-description">
        <p>
          <strong>How to play:</strong> Watch the glowing tiles. After the sequence finishes, 
          repeat it by tapping the same tiles in order.
        </p>
        <p>
          Tiles glow the same way during playback and when you tap them yourself.
        </p>
      </div>

      <div class="stats-row">
        <div class="metric-settings">
          <div id="best" class="pb-value">0</div>
          <div class="pb-label">Personal Best</div>
        </div>
      </div>

      <div class="settings-group">
        <label class="settings-label" for="startLen">Starting Length</label>
        <input class="input" id="startLen" type="number" min="1" max="9" value="3" inputmode="numeric">
        <small class="setting-help">Number of tiles in the first sequence (1-9).</small>
      </div>

      <div class="settings-group">
        <label class="settings-label" for="speed">Show Speed</label>
        <select class="input" id="speed">
          <option value="slow">Slow</option>
          <option value="med" selected>Medium</option>
          <option value="fast">Fast</option>
        </select>
        <small class="setting-help">How quickly the sequence plays back.</small>
      </div>

      <div class="settings-group">
        <label class="settings-label" for="roundGap">Wait Time Between Rounds</label>
        <select class="input" id="roundGap">
          <option value="1200">Short</option>
          <option value="1500" selected>Medium</option>
          <option value="2000">Long</option>
        </select>
        <small class="setting-help">How long to wait before each new pattern starts.</small>
      </div>

      <div class="settings-group">
        <label class="checkbox-group">
          <input type="checkbox" id="soundEnabled" checked>
          <span>Enable sound effects</span>
        </label>
        <small class="setting-help">Play tones when tiles light up (helps with memory).</small>
      </div>

      <div class="controls">
        <button class="btn btn-primary" id="start">Start</button>
      </div>
    </aside>

    <!-- Game Screen -->
    <section class="game-container" data-screen="game">
      <div class="hud panel">
        <div class="hud-group">
          <div id="score" class="hud-value">0</div>
          <div class="hud-label">Score</div>
        </div>

        <div class="hud-group">
          <div id="round" class="hud-value">1</div>
          <div class="hud-label">Round</div>
        </div>

        <div class="hud-group">
          <div id="pb" class="hud-value">0</div>
          <div class="hud-label">Best</div>
        </div>

        <div class="hud-group">
          <div id="time" class="hud-value">00:00</div>
          <div class="hud-label">Time</div>
        </div>

        <div class="controls">
          <button class="btn btn-secondary" id="pause">Pause</button>
          <button class="btn" id="end">Exit</button>
        </div>
      </div>

      <!-- Status Bar -->
      <div class="status-bar watching" id="statusBar">
        <span class="status-icon" id="statusIcon">üëÄ</span>
        <span id="statusText">Get ready...</span>
        <span class="progress-indicator" id="progressIndicator"></span>
      </div>

      <div class="panel grid-container">
        <div class="success-message" id="successMessage">Perfect! üéâ</div>
        <div class="grid" id="grid" aria-label="Rhythm pads">
          <button class="pad" data-idx="1" aria-label="Pad 1">1</button>
          <button class="pad" data-idx="2" aria-label="Pad 2">2</button>
          <button class="pad" data-idx="3" aria-label="Pad 3">3</button>
          <button class="pad" data-idx="4" aria-label="Pad 4">4</button>
          <button class="pad" data-idx="5" aria-label="Pad 5">5</button>
          <button class="pad" data-idx="6" aria-label="Pad 6">6</button>
          <button class="pad" data-idx="7" aria-label="Pad 7">7</button>
          <button class="pad" data-idx="8" aria-label="Pad 8">8</button>
          <button class="pad" data-idx="9" aria-label="Pad 9">9</button>
        </div>
      </div>
    </section>

    <!-- Summary Screen -->
    <section class="summary-panel panel" data-screen="summary">
      <h2>Session Complete!</h2>

      <div class="summary-stats">
        <div class="summary-stat highlight" id="summaryScoreStat">
          <div class="summary-stat-value" id="summaryScore">0</div>
          <div class="summary-stat-label">Final Score</div>
        </div>

        <div class="summary-stat">
          <div class="summary-stat-value" id="summaryRounds">0</div>
          <div class="summary-stat-label">Rounds Completed</div>
        </div>

        <div class="summary-stat">
          <div class="summary-stat-value" id="summaryAccuracy">0%</div>
          <div class="summary-stat-label">Accuracy</div>
        </div>

        <div class="summary-stat">
          <div class="summary-stat-value" id="summaryTime">00:00</div>
          <div class="summary-stat-label">Time Played</div>
        </div>

        <div class="summary-stat">
          <div class="summary-stat-value" id="summaryBest">0</div>
          <div class="summary-stat-label">Personal Best</div>
        </div>
      </div>

      <div class="summary-controls">
        <button class="btn btn-primary" id="playAgain">Play Again</button>
        <button class="btn btn-secondary" id="backToSettings">Settings</button>
      </div>
    </section>
  </main>

  <script>
    // ---------- Audio System ----------
    const Audio = (() => {
      let ctx = null;
      let enabled = true;
      let initialized = false;

      // Pentatonic scale frequencies for pleasant sounds
      const frequencies = [
        261.63, // C4 - pad 1
        293.66, // D4 - pad 2
        329.63, // E4 - pad 3
        392.00, // G4 - pad 4
        440.00, // A4 - pad 5
        523.25, // C5 - pad 6
        587.33, // D5 - pad 7
        659.25, // E5 - pad 8
        783.99, // G5 - pad 9
      ];

      function init() {
        if (initialized) return;
        
        try {
          // Create audio context only on user gesture (required by iOS Safari)
          const AudioContextClass = window.AudioContext || window.webkitAudioContext;
          if (!AudioContextClass) {
            console.warn('Web Audio API not supported');
            return;
          }
          
          ctx = new AudioContextClass();
          
          // iOS Safari requires resume after user interaction
          if (ctx.state === 'suspended') {
            ctx.resume().catch(() => {});
          }
          
          initialized = true;
        } catch (e) {
          console.warn('Audio initialization failed:', e);
        }
      }

      function playTone(padIndex, duration = 200) {
        if (!enabled || !ctx || !initialized) return;
        
        // Ensure context is running (iOS Safari requirement)
        if (ctx.state === 'suspended') {
          ctx.resume().catch(() => {});
        }
        
        try {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          
          osc.connect(gain);
          gain.connect(ctx.destination);
          
          osc.type = 'sine';
          osc.frequency.value = frequencies[padIndex - 1] || 440;
          
          gain.gain.setValueAtTime(0.3, ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration / 1000);
          
          osc.start(ctx.currentTime);
          osc.stop(ctx.currentTime + duration / 1000);
        } catch (e) {
          console.warn('Audio playback failed:', e);
        }
      }

      function playError() {
        if (!enabled || !ctx || !initialized) return;
        
        if (ctx.state === 'suspended') {
          ctx.resume().catch(() => {});
        }
        
        try {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          
          osc.connect(gain);
          gain.connect(ctx.destination);
          
          osc.type = 'sawtooth';
          osc.frequency.value = 150;
          
          gain.gain.setValueAtTime(0.2, ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
          
          osc.start(ctx.currentTime);
          osc.stop(ctx.currentTime + 0.15);
        } catch (e) {
          console.warn('Audio playback failed:', e);
        }
      }

      function playSuccess() {
        if (!enabled || !ctx || !initialized) return;
        
        if (ctx.state === 'suspended') {
          ctx.resume().catch(() => {});
        }
        
        // Play a quick ascending arpeggio
        [0, 100, 200].forEach((delay, i) => {
          setTimeout(() => {
            try {
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              
              osc.connect(gain);
              gain.connect(ctx.destination);
              
              osc.type = 'sine';
              osc.frequency.value = [523.25, 659.25, 783.99][i];
              
              gain.gain.setValueAtTime(0.25, ctx.currentTime);
              gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
              
              osc.start(ctx.currentTime);
              osc.stop(ctx.currentTime + 0.15);
            } catch (e) {}
          }, delay);
        });
      }

      function setEnabled(val) {
        enabled = val;
      }

      function isEnabled() {
        return enabled;
      }

      return { init, playTone, playError, playSuccess, setEnabled, isEnabled };
    })();

    // ---------- Utilities ----------
    const activeTimeouts = new Set();
    const sleep = (ms) => new Promise(res => { const t=setTimeout(()=>{activeTimeouts.delete(t);res();},ms); activeTimeouts.add(t); });
    function clearAllTimers(){ activeTimeouts.forEach(t=>clearTimeout(t)); activeTimeouts.clear(); }

    // ---------- Elements ----------
    const pads = Array.from(document.querySelectorAll('.pad'));

    const startBtn = document.getElementById('start');
    const pauseBtn = document.getElementById('pause');
    const endBtn   = document.getElementById('end');
    const playAgainBtn = document.getElementById('playAgain');
    const backToSettingsBtn = document.getElementById('backToSettings');

    const startLenInput = document.getElementById('startLen');
    const speedSelect   = document.getElementById('speed');
    const roundGapSelect= document.getElementById('roundGap');
    const soundEnabledCheck = document.getElementById('soundEnabled');

    const scoreEl = document.getElementById('score');
    const bestEl  = document.getElementById('best');
    const pbEl    = document.getElementById('pb');
    const timeEl  = document.getElementById('time');
    const roundEl = document.getElementById('round');

    const statusBar = document.getElementById('statusBar');
    const statusIcon = document.getElementById('statusIcon');
    const statusText = document.getElementById('statusText');
    const progressIndicator = document.getElementById('progressIndicator');

    const countdownOverlay = document.getElementById('countdownOverlay');
    const countdownNumber = document.getElementById('countdownNumber');

    const successMessage = document.getElementById('successMessage');

    // Summary elements
    const summaryScore = document.getElementById('summaryScore');
    const summaryRounds = document.getElementById('summaryRounds');
    const summaryAccuracy = document.getElementById('summaryAccuracy');
    const summaryTime = document.getElementById('summaryTime');
    const summaryBest = document.getElementById('summaryBest');
    const summaryScoreStat = document.getElementById('summaryScoreStat');

    // ---------- Screens ----------
    function setScreen(which){
      document.querySelectorAll('[data-screen]').forEach(el => el.classList.remove('active'));
      document.querySelector(`[data-screen="${which}"]`)?.classList.add('active');
    }

    // ---------- Status Bar ----------
    function setStatus(type, text, progress = '') {
      statusBar.className = 'status-bar ' + type;
      statusText.textContent = text;
      progressIndicator.textContent = progress;
      
      const icons = {
        'watching': 'üëÄ',
        'your-turn': 'üëÜ',
        'countdown': '‚è±Ô∏è',
        'success': '‚ú®'
      };
      statusIcon.textContent = icons[type] || 'üëÄ';
    }

    // ---------- Countdown ----------
    async function showCountdown() {
      countdownOverlay.classList.add('active');
      
      for (let i = 3; i >= 1; i--) {
        countdownNumber.textContent = i;
        countdownNumber.style.animation = 'none';
        countdownNumber.offsetHeight; // Trigger reflow
        countdownNumber.style.animation = 'countdown-pop 0.5s ease-out';
        await sleep(800);
      }
      
      countdownNumber.textContent = 'Go!';
      countdownNumber.style.animation = 'none';
      countdownNumber.offsetHeight;
      countdownNumber.style.animation = 'countdown-pop 0.5s ease-out';
      await sleep(500);
      
      countdownOverlay.classList.remove('active');
    }

    // ---------- Success Message ----------
    function showSuccess() {
      const messages = ['Perfect! üéâ', 'Nice! ‚≠ê', 'Great! üí´', 'Awesome! üåü'];
      successMessage.textContent = messages[Math.floor(Math.random() * messages.length)];
      successMessage.classList.remove('show');
      successMessage.offsetHeight;
      successMessage.classList.add('show');
      Audio.playSuccess();
    }

    // ---------- Lighting (single source of truth) ----------
    const Light = (() => {
      let lit = null;
      let offTO = null;

      function hardOff(){
        if(offTO){ clearTimeout(offTO); offTO = null; }
        if(lit !== null){
          pads[lit-1]?.classList.remove('glow');
          lit = null;
        }
      }

      function flash(idx, duration=500, playSound=true){
        return new Promise(res=>{
          hardOff();
          pads[idx-1]?.classList.add('glow');
          lit = idx;
          if (playSound) Audio.playTone(idx, duration);
          offTO = setTimeout(()=>{ offTO=null; hardOff(); res(); }, Math.max(80, Number(duration)||0));
        });
      }

      function off(){ hardOff(); }
      return { flash, off };
    })();

    // ---------- Game state ----------
    const LS_KEY = 'FPR_v1_rhythm_best';
    let running=false, paused=false, playingBack=false;
    let score=0, best=0, rounds=0;
    let seq=[], userIndex=0;
    let playbackToken=0;
    let correctTaps = 0, totalTaps = 0;
    let finalTimeStr = '00:00';

    // Timer (simple elapsed)
    let timerId = null, startTs = 0;
    function startTimer(){
      if(timerId) clearInterval(timerId);
      startTs = Date.now();
      timerId = setInterval(() => {
        const s = Math.floor((Date.now()-startTs)/1000);
        const mm = String(Math.floor(s/60)).padStart(2,'0');
        const ss = String(s%60).padStart(2,'0');
        timeEl.textContent = `${mm}:${ss}`;
        finalTimeStr = `${mm}:${ss}`;
      }, 200);
    }
    function stopTimer(){ if(timerId){ clearInterval(timerId); timerId=null; } }

    // PB
    function readPB(){
      const v = Number(localStorage.getItem(LS_KEY)||'0');
      best = Number.isFinite(v) ? v : 0;
      bestEl.textContent = best; pbEl.textContent = best;
    }
    function writePB(v){ localStorage.setItem(LS_KEY, String(v)); readPB(); }

    // Helpers
    function randPad(){ return 1 + Math.floor(Math.random()*9); }
    function clamp(v, lo, hi){ return Math.min(hi, Math.max(lo, v)); }
    function clearAllPadStates(){ pads.forEach(p => p.classList.remove('glow','wrong')); }

    // Timings shared by playback and taps
    function playbackTimings(){
      const speed = speedSelect.value;
      if(speed === 'slow') return { glow: 700, gap: 300 };
      if(speed === 'fast') return { glow: 380, gap: 160 };
      return { glow: 550, gap: 220 };
    }

    // ---------- Playback ----------
    async function playSequence(){
      const myToken = ++playbackToken;
      playingBack = true;

      Light.off(); clearAllPadStates();
      const { glow, gap } = playbackTimings();
      const roundDelay = Number(roundGapSelect.value) || 1500;

      setStatus('watching', 'Watch the sequence...', '');
      
      await sleep(roundDelay);
      if(myToken !== playbackToken || !running){ playingBack=false; return; }

      let stepNum = 0;
      for(const idx of seq){
        while(paused && myToken===playbackToken && running){ await sleep(40); }
        if(myToken !== playbackToken || !running) break;

        stepNum++;
        setStatus('watching', 'Watch the sequence...', `${stepNum}/${seq.length}`);
        
        await Light.flash(idx, glow);
        await sleep(gap);
      }

      Light.off();
      playingBack = false;
      userIndex = 0;
      
      if(myToken === playbackToken && running) {
        setStatus('your-turn', 'Your turn!', `0/${seq.length}`);
      }
    }

    // ---------- User input ----------
    function onUserPad(idx, pointerType='mouse'){
      if(!running || paused || playingBack) return;

      totalTaps++;
      
      const expected = seq[userIndex];
      if(idx === expected){
        correctTaps++;
        const { glow } = playbackTimings();
        Light.flash(idx, glow);
        // Haptic feedback (Android only - iOS doesn't support navigator.vibrate)
        if(navigator.vibrate && !/iPad|iPhone|iPod/.test(navigator.userAgent)){ 
          try{ navigator.vibrate(15); }catch(_){} 
        }

        if (pointerType !== 'keyboard') {
          const el = pads[idx-1];
          setTimeout(()=> el?.blur(), glow + 10);
        }

        score += 10; scoreEl.textContent = String(score);
        userIndex++;
        
        setStatus('your-turn', 'Your turn!', `${userIndex}/${seq.length}`);
        
        if(userIndex >= seq.length){
          showSuccess();
          setTimeout(() => {
            Light.off(); clearAllPadStates();
            rounds++; 
            roundEl.textContent = String(rounds);
            seq.push(randPad());
            playSequence();
          }, 700);
        }
      } else {
        Audio.playError();
        const el = pads[idx-1]; if(el){
          el.classList.add('wrong');
          const t = setTimeout(()=>{ el.classList.remove('wrong'); activeTimeouts.delete(t); }, 280);
          activeTimeouts.add(t);
        }
        score = Math.max(0, score - 5); scoreEl.textContent = String(score);
        userIndex = 0;
        setStatus('your-turn', 'Try again from start!', `0/${seq.length}`);
      }
    }

    pads.forEach(p => {
      p.addEventListener('pointerdown', e => {
        e.preventDefault();
        onUserPad(Number(p.dataset.idx), e.pointerType || 'mouse');
      });
      p.addEventListener('keydown', e => {
        if(e.key === 'Enter' || e.key === ' '){
          e.preventDefault();
          onUserPad(Number(p.dataset.idx), 'keyboard');
        }
      });
    });

    // ---------- Summary Screen ----------
    function showSummary() {
      const isNewPB = score > best;
      if (isNewPB) writePB(score);
      
      summaryScore.textContent = score;
      summaryRounds.textContent = rounds;
      summaryTime.textContent = finalTimeStr;
      summaryBest.textContent = Math.max(score, best);
      
      const accuracy = totalTaps > 0 ? Math.round((correctTaps / totalTaps) * 100) : 0;
      summaryAccuracy.textContent = accuracy + '%';
      
      // Highlight if new PB
      summaryScoreStat.classList.remove('new-pb');
      const existingBadge = summaryScoreStat.querySelector('.new-pb-badge');
      if (existingBadge) existingBadge.remove();
      
      if (isNewPB && score > 0) {
        summaryScoreStat.classList.add('new-pb');
        const badge = document.createElement('div');
        badge.className = 'new-pb-badge';
        badge.textContent = 'üèÜ NEW BEST!';
        summaryScoreStat.appendChild(badge);
      }
      
      setScreen('summary');
    }

    // ---------- Session control ----------
    function resetSessionState(){
      running=false; paused=false; playingBack=false; ++playbackToken;
      stopTimer(); clearAllTimers(); Light.off(); clearAllPadStates();
      score=0; rounds=0; seq=[]; userIndex=0;
      correctTaps=0; totalTaps=0; finalTimeStr='00:00';
      scoreEl.textContent='0'; timeEl.textContent='00:00'; roundEl.textContent='1';
      pauseBtn.textContent = 'Pause';
    }

    async function startSession(){
      resetSessionState(); readPB();
      
      // Initialize audio on user interaction
      Audio.init();
      Audio.setEnabled(soundEnabledCheck.checked);

      const startLen = clamp(Number(startLenInput.value)||3, 1, 9);
      for(let i=0;i<startLen;i++) seq.push(randPad());

      setScreen('game');
      
      // Show countdown
      await showCountdown();
      
      running = true; 
      rounds = 1;
      roundEl.textContent = '1';
      startTimer();
      await playSequence();
    }

    function endSession(){
      if(!running && !paused) return;
      running=false; paused=false; playingBack=false; ++playbackToken;
      stopTimer(); Light.off(); clearAllPadStates();
      showSummary();
    }

    function togglePause(){
      if(!running) return;
      paused = !paused;
      pauseBtn.textContent = paused ? 'Resume' : 'Pause';
    }

    document.addEventListener('visibilitychange', () => { if(document.hidden){ Light.off(); } });

    // ---------- Bindings ----------
    startBtn.addEventListener('click', startSession);
    endBtn.addEventListener('click', endSession);
    pauseBtn.addEventListener('click', togglePause);
    playAgainBtn.addEventListener('click', startSession);
    backToSettingsBtn.addEventListener('click', () => setScreen('settings'));
    
    soundEnabledCheck.addEventListener('change', () => {
      Audio.setEnabled(soundEnabledCheck.checked);
    });

    // ---------- Init ----------
    readPB(); setScreen('settings');
  </script>
</body>
</html>